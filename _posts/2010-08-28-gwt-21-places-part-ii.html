---
layout: post
title: GWT 2.1 Places â€“ Part II
published: true
---
<p><strong>Translation available in:</strong> <a href="http://blog.atolcd.com/?p=675" title="GWT 2.1 Places &ndash; Partie II">French</a>.</p>
<p><strong>Updated 2010-10-16:</strong> updated to GWT 2.1.0.</p>
<p>I previously described the core of <a href="{% post_url 2010-08-25-gwt-21-places %}">GWT 2.1 Places</a> and will now focus on the optional features.</p>
<h2>User confirmation before navigating</h2>
<p>In many applications, you want to have confirmation of the user before navigating away; this is mostly used when the user made changes and didn't yet save them. This can be easily accomplished with GWT 2.1 places: you'll register a <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceChangeRequestEvent.Handler.html"><code>PlaceChangeRequestEvent.Handler</code></a> on the event bus and call the <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceChangeRequestEvent.html"><code>PlaceChangeRequestEvent</code></a>'s <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceChangeRequestEvent.html#setWarning(java.lang.String)"><code>setWarning</code></a> method with a non-null value that will be used to ask confirmation to the user.</p>
<p>When calling <code>goTo</code> on the PlaceController, before changing the current place, it actually first fires a <code>PlaceChangeRequestEvent</code>. Once the event has been dispatched to all the handlers, the current place will actually be changed and the <code>PlaceChangeEvent</code> fired only in two cases:</p>
<ul>
<li>the event's warning property is null, or</li>
<li>the event's warning property is non-null and the user has confirmed the navigation. Confirmation is asked using a (browser-native) dialog box, with the event's warning property value used as the message presented to the user.</li>
</ul>
<p>Additionally, when navigating away or closing the window or tab (i.e. quitting the application), such a <code>PlaceChangeRequestEvent</code> is also fired (with the next place set to <code>Place.NOWHERE</code>), and setting a non-null warning value will also ask the user confirmation (for those interested in the gory details, this is accomplished by setting the <code>Window.ClosingEvent</code>'s message).</p>
<h2>Integration with RequestFactory</h2>
<p>GWT 2.1 does not come with built-in direct integration with <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/requestfactory/shared/RequestFactory.html"><code>RequestFactory</code></a>. You'll find a preview of what'll come in a later release in the code for the Expenses sample, in the form of two concrete places that can help you when a place is tied to a <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/requestfactory/shared/EntityProxy.html"><code>EntityProxy</code></a> instance or type: the <code>ProxyListPlace</code> represents the list of records of a given type, while the <code>ProxyPlace</code> models an operation (create, show details, or edit) on a particular record instance.</p>
<h2>Integration with the browser's history</h2>
<p>Integration with the browser's history means:</p>
<ol>
<li>serializing the current place to the URL so it can be bookmarked and creating an entry in the browser's navigation history; and</li>
<li>deserializing the URL back to a place, and fire the appropriate events to the event bus to finally update the current place.</li>
</ol>
<p>#1 is done when the place changes due to a call to the PlaceController's goTo, while #2 is triggered by the browser when the user either navigates in its history through the browser's "previous page" and "next page" buttons, or loads a previously bookmarked URL generated by #1.</p>
<p>To use this feature, you'll first create <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceTokenizer.html"><code>PlaceTokenizer</code></a>s to map <em>history tokens</em> to/from places, and then an (empty) interface, extending <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceHistoryMapper.html"><code>PlaceHistoryMapper</code></a> and annotated with <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/WithTokenizers.html"><code>@WithTokenizers</code></a> to declare the <code>PlaceTokenizer</code>s to be used, that you'll <code>GWT.create()</code> and finally register, through a <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceHistoryHandler.html"><code>PlaceHistoryHandler</code></a>, with the PlaceController, the EventBus and a default place (the place to use when there's no token, or when the token cannot be mapped to a place).</p>

{% highlight java %}
@WithTokenizers(FooPlaceTokenizer.class, BarPlaceTokenizer.class)
interface MyPlaceHistoryMapper extends PlaceHistoryMapper {
}

PlaceHistoryMapper historyMapper = GWT.create(MyPlaceHistoryMapper.class);
PlaceHistoryHandler historyHandler = new PlaceHistoryHandler(historyMapper);
historyHandler.register(placeController, eventBus, defaultPlace);
{% endhighlight %}

<h3>How does the PlaceHistoryHandler maps history tokens to places?</h3>
<p>Each PlaceTokenizer is associated with a token prefix using a <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/Prefix.html"><code>@Prefix</code></a> annotation. The PlaceHistoryHandler splits the history token on the first colon, compares the left-hand part to the prefixes it knows, and then GWT.create() the matched PlaceTokenizer class and call its <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceTokenizer.html#getPlace(java.lang.String)"><code>getPlace</code></a> method with the right-hand part as the argument.</p>
<h3>How does the PlaceHistoryHandler maps places to history tokens?</h3>
<p>PlaceTokenizer is a generic class actually defined as <code>PlaceTokenizer&lt;P extends Place&gt;</code>. When the code generator runs on the PlaceHistoryHandler, it examines the PlaceTokenizers and extracts their <code>P</code> generic type argument. This information is then used at runtime to map a place to the appropriate PlaceTokenizer class, so that the PlaceHistoryHandler can GWT.create() an instance of it and call its <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceTokenizer.html#getToken(P)"><code>getToken</code></a> method. The returned value will them be prepended with the PlaceTokenizer's @Prefix and a colon as a separator, and the resulting String is used as the history token.</p>
<h3>Using a factory for your PlaceTokenizer</h3>
<p>There are times where your PlaceTokenizer has a dependency on other objects, but there's no place for customization in the above algorithm, instantiating a PlaceTokenizer every time they need one and throwing it away right after that. Here comes the <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceHistoryMapperWithFactory.html"><code>PlaceHistoryHandlerWithFactory</code></a>: you'll inherit from this interface instead of PlaceHistoryHandler and then call <a href="http://google-web-toolkit.googlecode.com/svn/javadoc/2.1/com/google/gwt/place/shared/PlaceHistoryMapperWithFactory.html#setFactory(F)"><code>setFactory</code></a> with a factory (or provider) of PlaceTokenizers right before initializing it.</p>
<p>PlaceHistoryHandlerWithFactory takes a generic type argument, which the code generator will introspect to collect all zero-argument methods whose return type is assignable to PlaceTokenizer. The generated class will call these methods instead of using GWT.create() when it needs a PlaceTokenizer; the methods can also be annotated with @Prefix to override the annotation possibly present on the PlaceTokenizer subclass; finally, PlaceTokenizer classes that your factory can provide mustn't be specified in the @WithTokenizer annotation, which therefore becomes optional.</p>
<p>Your factory can really be any class or interface, which means you can even use a <code>Ginjector</code> if you're using GIN for dependency-injection.</p>
<h3>Using your own mapper, without PlaceTokenizer</h3>
<p>You're actually not required to <code>GWT.create()</code> a <code>ProxyHistoryMapper</code>, and rely on the generated code based on <code>PlaceTokenizer</code>s, you can very well implement the interface yourself, the way you want it. And not only it is technically possible, but it is a supported use case (believe me on this one, I'm the one who submitted the patch).</p>
<h2>What's next?</h2>
<p>The <a href="{% post_url 2010-09-05-gwt-21-activities %}" title="GWT 2.1 Activities">next article</a> will be about GWT 2.1 activities, which sits above places, abstracting events' handling, and is probably what the GWT team call the "MVP framework" even though, actually, it helps in doing MVP but doesn't enforce its use, and you'll probably also need to build MVP components that are not activities&hellip; Still, GWT 2.1 activities are a wonderful API to work with, stay tuned!</p>
